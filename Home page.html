<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ - Norix</title>
    <style>
        /* --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ --- */
        :root {
            --primary-color: #4a90e2;
            --primary-hover-color: #357abd;
            --primary-color-rgb: 74, 144, 226;
            --danger-color: #d0021b;
            --danger-hover-color: #a30215;
            --success-color: #7ed321;
            --success-hover-color: #62a81a;
            --font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --border-radius-sm: 8px;
            --border-radius-md: 16px;

            /* Light Theme */
            --bg-color: #f5f7fa;
            --card-bg-color: #ffffff;
            --header-bg-color: #ffffff;
            --text-color: #333;
            --light-text-color: #777;
            --border-color: #e0e6ed;
            --shadow-light: rgba(0,0,0,0.05);
            --shadow-medium: rgba(0,0,0,0.1);
            --input-bg-color: #fdfdfd;
        }

        /* Dark Theme */
        body.dark-theme {
            --bg-color: #121212;
            --card-bg-color: #1e1e1e;
            --header-bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --light-text-color: #a0a0a0;
            --border-color: #333;
            --shadow-light: rgba(0,0,0,0.2);
            --shadow-medium: rgba(0,0,0,0.3);
            --input-bg-color: #2a2a2a;
        }
        
        /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ --- */
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap');
        
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- Ù‡Ø¯Ø± --- */
        .header {
            background-color: var(--header-bg-color);
            padding: 15px 30px;
            box-shadow: 0 2px 5px var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title {
            font-size: 24px;
            font-weight: 700;
        }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .icon-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 42px;
            height: 42px;
            cursor: pointer;
            font-size: 22px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            transition: all 0.2s ease;
        }
        .icon-btn:hover { background-color: var(--bg-color); border-color: var(--primary-color); }
        #logout-btn {
            background: none;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 8px 18px;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            font-family: var(--font-family);
            transition: all 0.3s ease;
        }
        #logout-btn:hover { background-color: var(--danger-color); color: #fff; transform: translateY(-2px); }

        /* --- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ --- */
        .main-container { padding: 30px; }
        #server-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        /* --- Ø·Ø±Ø§Ø­ÛŒ Ø¬Ø¯ÛŒØ¯ Ú©Ø§Ø±Øª Ø³Ø±ÙˆØ± --- */
        .server-card {
            background: var(--card-bg-color);
            border-radius: var(--border-radius-md);
            box-shadow: 0 4px 15px var(--shadow-light);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-top: 5px solid var(--primary-color);
        }
        .server-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow-medium);
        }
        .server-card-content { padding: 20px 25px; flex-grow: 1; }
        .server-card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .server-icon { font-size: 36px; line-height: 1; }
        .server-details { flex-grow: 1; }
        .server-name { font-size: 18px; font-weight: 600; margin: 0; }
        .server-id { font-size: 12px; color: var(--light-text-color); }
        .server-card-footer {
            padding: 15px 25px;
            background-color: var(--bg-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        .server-meta span {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 6px;
            background: var(--border-color);
            font-weight: 500;
        }
        .edit-server-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 20px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            border: none;
            transition: all 0.2s ease;
        }
        .edit-server-btn:hover { background-color: var(--primary-hover-color); }

        /* --- Ø­Ø§Ù„Øª Ø®Ø§Ù„ÛŒ --- */
        #empty-state {
            text-align: center;
            margin-top: 50px;
            color: var(--light-text-color);
        }
        #empty-state svg { width: 150px; margin-bottom: 20px; opacity: 0.7; }
        #empty-state h3 { font-size: 22px; color: var(--text-color); margin: 0; }
        #empty-state p { font-size: 16px; margin-top: 10px; }

        /* --- Ø¯Ú©Ù…Ù‡ Ø´Ù†Ø§ÙˆØ± Ø§ÙØ²ÙˆØ¯Ù† --- */
        #add-server-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 20px rgba(var(--primary-color-rgb), 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #add-server-btn:hover { background-color: var(--primary-hover-color); transform: scale(1.1) rotate(90deg); }

        /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ù…ÙˆØ¯Ø§Ù„ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; z-index: 1000;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 16px; box-sizing: border-box;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius-md);
            width: 100%; max-width: 750px;
            max-height: 90vh; box-sizing: border-box;
            box-shadow: 0 10px 40px var(--shadow-medium);
            display: flex; flex-direction: column;
            transform: scale(0.95) translateY(10px);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .modal-overlay.visible .modal-content { transform: scale(1) translateY(0); }
        .modal-form { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .modal-title {
            font-size: 24px; font-weight: 600; margin: 0; padding: 25px 30px;
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        .modal-body {
            overflow-y: auto; padding: 30px; display: grid;
            grid-template-columns: repeat(2, 1fr); gap: 25px; flex-grow: 1;
        }
        .modal-actions {
            display: flex; justify-content: flex-end; gap: 12px; margin-top: auto;
            border-top: 1px solid var(--border-color); padding: 20px 30px;
            background-color: var(--bg-color);
            border-bottom-left-radius: var(--border-radius-md);
            border-bottom-right-radius: var(--border-radius-md);
            flex-shrink: 0;
        }
        .modal-btn {
            padding: 12px 24px; border: none; border-radius: var(--border-radius-sm);
            font-size: 16px; font-weight: 600; font-family: inherit;
            cursor: pointer; transition: all 0.2s ease;
        }
        .btn-primary { background-color: var(--primary-color); color: #fff; order: 3; }
        .btn-primary:hover { background-color: var(--primary-hover-color); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(var(--primary-color-rgb), 0.3); }
        .btn-secondary { background-color: transparent; color: var(--text-color); border: 1px solid var(--border-color); order: 2; }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn-danger { background-color: transparent; color: var(--danger-color); font-weight: 500; order: 1; margin-right: auto; }
        .btn-danger:hover { background-color: rgba(208, 2, 27, 0.1); }
        .btn-success { background-color: var(--success-color); color: #fff; }
        .btn-success:hover { background-color: var(--success-hover-color); transform: translateY(-2px); }
        
        /* --- Ø§Ø³ØªØ§ÛŒÙ„ ÙØ±Ù…â€ŒÙ‡Ø§ --- */
        .input-group { text-align: right; display: flex; flex-direction: column; }
        .input-group label { margin-bottom: 8px; font-weight: 600; font-size: 15px; }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm); box-sizing: border-box; font-size: 16px;
            font-family: inherit; background-color: var(--input-bg-color); color: var(--text-color);
            transition: all 0.2s ease;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2);
        }
        .full-width { grid-column: 1 / -1; }
        #json-content-input, #html-content-input { min-height: 200px; direction: ltr; text-align: left; font-family: 'Courier New', Courier, monospace; resize: vertical; }
        #html-preview { width: 100%; height: 200px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background-color: var(--card-bg-color); }
        
        .personalization-group { display: flex; gap: 15px; align-items: flex-end; }
        .personalization-group > div:first-child { flex-grow: 1; }
        .personalization-group input[type="color"] { min-width: 50px; height: 50px; padding: 5px; cursor: pointer; }
        .server-link-container {
            margin-top: 15px; background-color: var(--bg-color); padding: 12px 15px; border-radius: var(--border-radius-sm);
            display: flex; align-items: center; gap: 10px;
        }
        .server-link-container label { font-size: 14px; margin: 0; font-weight: 600; }
        .server-link-container input { flex-grow: 1; border: none; background: none; font-size: 14px; color: var(--primary-color); direction: ltr; padding: 0;}
        .server-link-container button { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--text-color); }
        .tooltip { position: relative; }
        .tooltip .tooltip-text {
            visibility: hidden; background-color: #333; color: #fff; text-align: center;
            border-radius: 6px; padding: 5px 10px; position: absolute; z-index: 1;
            bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s;
        }
        .tooltip .tooltip-text.visible { visibility: visible; opacity: 1; }

        #modal-message { color: var(--danger-color); min-height: 20px; font-weight: 500; text-align: center; }

        /* --- Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ --- */
        #profile-modal .modal-body { grid-template-columns: 1fr; }
        .profile-info { padding: 15px; background-color: var(--bg-color); border-radius: var(--border-radius-sm); text-align: center; }
        .profile-info p { margin: 0; }
        .profile-info strong { color: var(--primary-color); }
        .divider { grid-column: 1 / -1; height: 1px; background: var(--border-color); margin: 10px 0; }

        /* --- Ù„ÙˆØ¯Ø± --- */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.7); display: none;
            justify-content: center; align-items: center; z-index: 9999;
        }
        body.dark-theme .loader-overlay { background: rgba(0, 0, 0, 0.7); }
        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--border-color);
            border-top-color: var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


        /* --- Ø±Ø³Ù¾Ø§Ù†Ø³ÛŒÙˆ --- */
        @media (max-width: 768px) {
            .modal-body { grid-template-columns: 1fr; padding: 20px; gap: 20px; }
            .modal-actions { flex-direction: column-reverse; }
            .modal-btn { width: 100%; }
            #add-server-btn { bottom: 20px; right: 20px; left: auto; }
        }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay"><div class="spinner"></div></div>

    <header class="header">
        <h1 class="header-title">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ø±ÙˆØ±Ù‡Ø§</h1>
        <div class="header-actions">
            <button id="profile-btn" class="icon-btn" title="Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ">ğŸ‘¤</button>
            <button id="theme-toggle-btn" class="icon-btn" title="ØªØºÛŒÛŒØ± ØªÙ…">â˜€ï¸</button>
            <button id="logout-btn">Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <main class="main-container">
        <div id="server-list"></div>
        <div id="empty-state" style="display: none;">
            <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M888 792H200V168c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v688c0 4.4 3.6 8 8 8h752c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM288 604a8 8 0 0 0 16 0v-88a8 8 0 0 0-16 0v88zm112 0a8 8 0 0 0 16 0v-144a8 8 0 0 0-16 0v144zm112 0a8 8 0 0 0 16 0V328a8 8 0 0 0-16 0v276zm112 0a8 8 0 0 0 16 0V448a8 8 0 0 0-16 0v156zm112 0a8 8 0 0 0 16 0V384a8 8 0 0 0-16 0v220zM832 112H440c-4.4 0-8 3.6-8 8v504c0 4.4 3.6 8 8 8h392c4.4 0 8-3.6 8-8V120c0-4.4-3.6-8-8-8zm-48 488H488V160h304v440z"/></svg>
            <h3>Ù‡Ù†ÙˆØ² Ø³Ø±ÙˆØ±ÛŒ Ù†Ø³Ø§Ø®ØªÙ‡â€ŒØ§ÛŒØ¯!</h3>
            <p>Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø§ÙˆÙ„ÛŒÙ† Ø³Ø±ÙˆØ± Ø®ÙˆØ¯ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ + Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</p>
        </div>
    </main>

    <button id="add-server-btn" title="Ø³Ø§Ø®Øª Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯">+</button>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø³Ø§Ø®Øª Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ø³Ø±ÙˆØ± -->
    <div id="server-modal" class="modal-overlay">
        <div class="modal-content">
            <form id="server-form" class="modal-form" onsubmit="return false;">
                <h2 id="modal-title" class="modal-title"></h2>
                <div class="modal-body">
                    <input type="hidden" id="server-id-input">
                    <div class="input-group">
                        <label for="server-name-input">Ù†Ø§Ù… Ø³Ø±ÙˆØ±</label>
                        <input type="text" id="server-name-input" required>
                    </div>
                    <div class="input-group">
                        <label for="server-type-select">Ù†ÙˆØ¹ Ø³Ø±ÙˆØ±</label>
                        <select id="server-type-select">
                            <option value="json">JSON</option>
                            <option value="html">HTML</option>
                        </select>
                    </div>
                    <div class="input-group full-width" id="password-container">
                        <label for="server-password-input">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø³Ø±ÙˆØ±</label>
                        <input type="password" id="server-password-input">
                    </div>
                    <div class="input-group personalization-group full-width">
                         <div>
                            <label for="server-icon-input">Ø¢ÛŒÚ©ÙˆÙ† (Ø§ÛŒÙ…ÙˆØ¬ÛŒ)</label>
                            <input type="text" id="server-icon-input" maxlength="2" placeholder="ğŸš€">
                         </div>
                         <div>
                            <label for="server-color-input">Ø±Ù†Ú¯</label>
                            <input type="color" id="server-color-input" value="#4a90e2">
                         </div>
                    </div>
                    <div class="input-group full-width">
                        <label>Ù†Ù…Ø§ÛŒØ´ Ø¹Ù…ÙˆÙ…ÛŒ (Public)</label>
                        <select id="server-visibility-select">
                            <option value="public">Ø¹Ù…ÙˆÙ…ÛŒ (Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ Ø¨Ø§ Ù„ÛŒÙ†Ú©)</option>
                            <option value="private">Ø®ØµÙˆØµÛŒ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§)</option>
                        </select>
                    </div>
                    <div class="editor-container full-width" id="json-editor-container">
                        <label for="json-content-input">Ù…Ø­ØªÙˆØ§ÛŒ JSON</label>
                        <textarea id="json-content-input" placeholder='{ "key": "value" }'></textarea>
                    </div>
                    <div class="editor-container full-width" id="html-editor-container" style="display: none;">
                        <label for="html-content-input">Ù…Ø­ØªÙˆØ§ÛŒ HTML</label>
                        <textarea id="html-content-input" placeholder="<h1>Ø³Ù„Ø§Ù… Ø¯Ù†ÛŒØ§!</h1>"></textarea>
                    </div>
                    <div class="html-preview-container full-width" id="html-preview-wrapper" style="display: none;">
                        <label>Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡</label>
                        <iframe id="html-preview" srcdoc=""></iframe>
                    </div>
                    <div class="server-link-container full-width" style="display: none;" id="server-link-wrapper">
                        <label>Ù„ÛŒÙ†Ú© Ø¹Ù…ÙˆÙ…ÛŒ:</label>
                        <input type="text" id="server-link-input" readonly>
                        <div class="tooltip">
                            <button type="button" id="copy-link-btn">ğŸ“‹</button>
                            <span class="tooltip-text" id="copy-tooltip">Ú©Ù¾ÛŒ Ø´Ø¯!</span>
                        </div>
                    </div>
                    <p id="modal-message" class="full-width"></p>
                </div>
                <div class="modal-actions">
                    <button type="button" id="delete-btn" class="modal-btn btn-danger" style="display: none;">Ø­Ø°Ù</button>
                    <button type="button" id="cancel-btn" class="modal-btn btn-secondary">Ù„ØºÙˆ</button>
                    <button type="button" id="submit-btn" class="modal-btn btn-primary"></button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ -->
    <div id="profile-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
             <form id="profile-form" class="modal-form" onsubmit="return false;">
                <h2 class="modal-title">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
                <div class="modal-body">
                    <div class="profile-info full-width">
                        <p>Ø´Ù…Ø§ Ø¨Ø§ Ø§ÛŒÙ…ÛŒÙ„ <strong id="user-email-display"></strong> ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯.</p>
                    </div>
                    
                    <div class="input-group full-width">
                        <label for="display-name-input">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label>
                        <input type="text" id="display-name-input" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                    </div>

                    <div class="divider"></div>

                    <div class="input-group full-width">
                        <label>Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                        <button type="button" id="reset-password-btn" class="modal-btn btn-secondary">Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</button>
                    </div>
                    <p id="profile-modal-message" class="full-width"></p>
                </div>
                <div class="modal-actions">
                    <button type="button" id="profile-cancel-btn" class="modal-btn btn-secondary">Ø¨Ø³ØªÙ†</button>
                    <button type="button" id="profile-submit-btn" class="modal-btn btn-success">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAT8CDJoCOm8XVo62y-3CgS1Fqabdq2tjQ",
            authDomain: "serverjson-a2107.firebaseapp.com",
            projectId: "serverjson-a2107",
            storageBucket: "serverjson-a2107.appspot.com",
            messagingSenderId: "1058313915119",
            appId: "1:1058313915119:web:4a967e4c8c401f1762a91a",
            databaseURL: "https://serverjson-a2107-default-rtdb.firebaseio.com"
        };

        // --- Firebase Initialization ---
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // --- Global Variables ---
        let currentUser;
        let userServers = [];

        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const serverList = document.getElementById('server-list');
        const emptyState = document.getElementById('empty-state');
        const addServerBtn = document.getElementById('add-server-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const profileBtn = document.getElementById('profile-btn');

        // Server Modal Elements
        const serverModal = document.getElementById('server-modal');
        const modalTitle = document.getElementById('modal-title');
        const serverForm = document.getElementById('server-form');
        const serverIdInput = document.getElementById('server-id-input');
        const serverNameInput = document.getElementById('server-name-input');
        const serverPasswordInput = document.getElementById('server-password-input');
        const passwordContainer = document.getElementById('password-container');
        const serverTypeSelect = document.getElementById('server-type-select');
        const jsonEditorContainer = document.getElementById('json-editor-container');
        const htmlEditorContainer = document.getElementById('html-editor-container');
        const jsonContentInput = document.getElementById('json-content-input');
        const htmlContentInput = document.getElementById('html-content-input');
        const htmlPreviewWrapper = document.getElementById('html-preview-wrapper');
        const htmlPreview = document.getElementById('html-preview');
        const serverIconInput = document.getElementById('server-icon-input');
        const serverColorInput = document.getElementById('server-color-input');
        const serverVisibilitySelect = document.getElementById('server-visibility-select');
        const serverLinkWrapper = document.getElementById('server-link-wrapper');
        const serverLinkInput = document.getElementById('server-link-input');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const copyTooltip = document.getElementById('copy-tooltip');
        const modalMessage = document.getElementById('modal-message');
        const cancelBtn = document.getElementById('cancel-btn');
        const submitBtn = document.getElementById('submit-btn');
        const deleteBtn = document.getElementById('delete-btn');

        // Profile Modal Elements
        const profileModal = document.getElementById('profile-modal');
        const userEmailDisplay = document.getElementById('user-email-display');
        const displayNameInput = document.getElementById('display-name-input');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        const profileModalMessage = document.getElementById('profile-modal-message');
        const profileCancelBtn = document.getElementById('profile-cancel-btn');
        const profileSubmitBtn = document.getElementById('profile-submit-btn');

        // --- Helper Functions ---
        const showLoader = () => loader.style.display = 'flex';
        const hideLoader = () => loader.style.display = 'none';

        // --- Theme Management ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                themeToggleBtn.textContent = 'ğŸŒ™';
            } else {
                document.body.classList.remove('dark-theme');
                themeToggleBtn.textContent = 'â˜€ï¸';
            }
        }
        async function saveThemePreference(theme) {
            if (!currentUser) return;
            const userDocRef = db.collection('users').doc(currentUser.uid);
            await userDocRef.set({ preferences: { theme: theme } }, { merge: true });
        }
        
        // --- Auth Management ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                profileBtn.title = currentUser.displayName || currentUser.email;
                await loadUserServersAndPreferences();
            } else {
                window.location.href = './Login.html';
            }
        });

        // --- Data Loading ---
        async function loadUserServersAndPreferences() {
            showLoader();
            try {
                const userDocRef = db.collection('users').doc(currentUser.uid);
                const doc = await userDocRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    const savedTheme = data.preferences?.theme || 'light';
                    applyTheme(savedTheme);
                    userServers = data.servers || [];
                    renderServerList();
                } else {
                    applyTheme('light');
                    userServers = [];
                    renderServerList();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª.");
            } finally {
                hideLoader();
            }
        }
        
        // --- UI Rendering ---
        function renderServerList() {
            serverList.innerHTML = '';
            if (userServers.length === 0) {
                emptyState.style.display = 'block';
                serverList.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                serverList.style.display = 'grid';
                userServers.forEach(displayServerCard);
            }
        }

        function displayServerCard(server) {
            const card = document.createElement('div');
            card.className = 'server-card';
            card.dataset.serverId = server.id;
            card.style.borderTopColor = server.color || 'var(--primary-color)';
            
            const visibilityIcon = server.visibility === 'public' ? 'ğŸŒ' : 'ğŸ”’';
            const serverType = server.type.toUpperCase();

            card.innerHTML = `
                <div class="server-card-content">
                    <div class="server-card-header">
                        <span class="server-icon">${server.icon || 'ğŸš€'}</span>
                        <div class="server-details">
                            <p class="server-name">${server.name}</p>
                            <span class="server-id">ID: ${server.id}</span>
                        </div>
                    </div>
                </div>
                <div class="server-card-footer">
                    <div class="server-meta">
                        <span>${serverType}</span>
                        <span>${visibilityIcon} ${server.visibility === 'public' ? 'Ø¹Ù…ÙˆÙ…ÛŒ' : 'Ø®ØµÙˆØµÛŒ'}</span>
                    </div>
                    <button class="edit-server-btn">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                </div>
            `;
            card.querySelector('.edit-server-btn').addEventListener('click', () => openModalForEdit(server));
            serverList.appendChild(card);
        }
        
        // --- Server Modal Management ---
        function toggleEditorView(type) {
            jsonEditorContainer.style.display = (type === 'json') ? 'block' : 'none';
            htmlEditorContainer.style.display = (type === 'html') ? 'block' : 'none';
            htmlPreviewWrapper.style.display = (type === 'html') ? 'block' : 'none';
        }

        function openModalForCreate() {
            serverForm.reset();
            serverIdInput.value = '';
            modalTitle.textContent = 'Ø³Ø§Ø®Øª Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯';
            submitBtn.textContent = 'Ø³Ø§Ø®ØªÙ†';
            serverPasswordInput.required = true;
            passwordContainer.style.display = 'block';
            serverTypeSelect.disabled = false;
            deleteBtn.style.display = 'none';
            serverLinkWrapper.style.display = 'none';
            serverColorInput.value = '#4a90e2';
            serverIconInput.value = 'ğŸš€';
            serverVisibilitySelect.value = 'public';
            toggleEditorView('json');
            serverModal.classList.add('visible');
        }

        function openModalForEdit(server) {
            serverForm.reset();
            serverIdInput.value = server.id;
            serverNameInput.value = server.name;
            serverTypeSelect.value = server.type || 'json';
            serverTypeSelect.disabled = true;
            serverPasswordInput.required = false;
            passwordContainer.style.display = 'none';
            serverIconInput.value = server.icon || 'ğŸš€';
            serverColorInput.value = server.color || '#4a90e2';
            serverVisibilitySelect.value = server.visibility || 'public';
            modalTitle.textContent = `ÙˆÛŒØ±Ø§ÛŒØ´: ${server.name}`;
            submitBtn.textContent = 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
            
            if (server.type === 'html') {
                htmlContentInput.value = server.content || '';
                htmlPreview.srcdoc = server.content || '';
            } else {
                jsonContentInput.value = JSON.stringify(server.content || {}, null, 2);
            }
            toggleEditorView(server.type || 'json');
            
            updateServerLink(server);
            
            deleteBtn.style.display = 'block';
            serverModal.classList.add('visible');
        }

        function updateServerLink(server) {
            if (server.visibility === 'public') {
                const realLink = server.type === 'html' 
                    ? `https://abolfazl140122.github.io/serverJson/view.html?id=${server.id}`
                    : `${firebaseConfig.databaseURL}/servers/${server.id}.json`;
                
                serverLinkInput.value = realLink;
                serverLinkInput.onclick = () => window.open(realLink, '_blank');
                serverLinkWrapper.style.display = 'flex';
            } else {
                serverLinkWrapper.style.display = 'none';
            }
        }

        function closeModal(modalElement) {
            modalElement.classList.remove('visible');
            modalMessage.textContent = '';
            profileModalMessage.textContent = '';
        }

        // --- Profile Modal Management ---
        function openProfileModal() {
            displayNameInput.value = currentUser.displayName || '';
            userEmailDisplay.textContent = currentUser.email;
            profileModalMessage.textContent = '';
            profileModal.classList.add('visible');
        }

        async function handleProfileUpdate() {
            const newDisplayName = displayNameInput.value.trim();
            if (newDisplayName === currentUser.displayName) return;

            showLoader();
            try {
                await currentUser.updateProfile({
                    displayName: newDisplayName
                });
                profileModalMessage.textContent = 'Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.';
                profileModalMessage.style.color = 'var(--success-color)';
                profileBtn.title = newDisplayName;
            } catch (error) {
                console.error("Error updating profile:", error);
                profileModalMessage.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„.';
                profileModalMessage.style.color = 'var(--danger-color)';
            } finally {
                hideLoader();
            }
        }

        async function handlePasswordReset() {
            if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ØŸ')) return;
            
            showLoader();
            try {
                await auth.sendPasswordResetEmail(currentUser.email);
                profileModalMessage.textContent = 'Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±ÙˆØ¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.';
                profileModalMessage.style.color = 'var(--success-color)';
            } catch (error) {
                console.error("Error sending password reset email:", error);
                profileModalMessage.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
                profileModalMessage.style.color = 'var(--danger-color)';
            } finally {
                hideLoader();
            }
        }

        // --- Firebase Operations ---
        function sanitizeForPublicDb(server) {
            return {
                type: server.type,
                name: server.name,
                icon: server.icon,
                content: server.content || (server.type === 'html' ? '' : {})
            };
        }

        async function handleFormSubmit() {
            showLoader();
            modalMessage.textContent = '';
            const serverId = serverIdInput.value;
            try {
                if (serverId) {
                    await updateServer(serverId);
                } else {
                    await createNewServer();
                }
                closeModal(serverModal);
                await loadUserServersAndPreferences();
            } catch (error) {
                console.error("Form submission error:", error);
                modalMessage.textContent = error.message || 'ÛŒÚ© Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø±Ø® Ø¯Ø§Ø¯.';
            } finally {
                hideLoader();
            }
        }

        async function createNewServer() {
            const serverName = serverNameInput.value.trim();
            const serverPassword = serverPasswordInput.value.trim();
            if (!serverName || !serverPassword) throw new Error('Ù†Ø§Ù… Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø³Ø±ÙˆØ± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.');

            const serverType = serverTypeSelect.value;
            const content = serverType === 'html' 
                ? "<h1>Ø³Ø±ÙˆØ± HTML Ø¬Ø¯ÛŒØ¯</h1>" 
                : { message: "Ø³Ø±ÙˆØ± JSON Ø¬Ø¯ÛŒØ¯" };

            const newServer = {
                id: Date.now().toString(),
                name: serverName,
                password: serverPassword, 
                type: serverType,
                icon: serverIconInput.value.trim() || 'ğŸš€',
                color: serverColorInput.value,
                visibility: serverVisibilitySelect.value,
                content: content
            };
            
            const userDocRef = db.collection('users').doc(currentUser.uid);
            const firestorePromise = userDocRef.set({
                servers: firebase.firestore.FieldValue.arrayUnion(newServer)
            }, { merge: true });

            let rtdbPromise = Promise.resolve();
            if (newServer.visibility === 'public') {
                rtdbPromise = rtdb.ref('servers/' + newServer.id).set(sanitizeForPublicDb(newServer));
            }
            await Promise.all([firestorePromise, rtdbPromise]);
        }

        async function updateServer(serverId) {
            const serverIndex = userServers.findIndex(s => s.id === serverId);
            if (serverIndex === -1) throw new Error('Ø³Ø±ÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯.');

            const serverToUpdate = { ...userServers[serverIndex] };
            serverToUpdate.name = serverNameInput.value.trim() || 'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…';
            serverToUpdate.icon = serverIconInput.value.trim() || 'ğŸš€';
            serverToUpdate.color = serverColorInput.value;
            serverToUpdate.visibility = serverVisibilitySelect.value;
            
            if (serverToUpdate.type === 'html') {
                serverToUpdate.content = htmlContentInput.value;
            } else {
                try {
                    serverToUpdate.content = jsonContentInput.value.trim() ? JSON.parse(jsonContentInput.value) : {};
                } catch (e) {
                    throw new Error('Ù…Ø­ØªÙˆØ§ÛŒ JSON Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.');
                }
            }
            
            userServers[serverIndex] = serverToUpdate;
            const userDocRef = db.collection('users').doc(currentUser.uid);
            const firestorePromise = userDocRef.update({ servers: userServers });

            let rtdbPromise;
            if (serverToUpdate.visibility === 'public') {
                rtdbPromise = rtdb.ref('servers/' + serverId).set(sanitizeForPublicDb(serverToUpdate));
            } else {
                rtdbPromise = rtdb.ref('servers/' + serverId).remove();
            }
            await Promise.all([firestorePromise, rtdbPromise]);
        }

        async function deleteServer() {
            const serverId = serverIdInput.value;
            if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø³Ø±ÙˆØ± "${serverNameInput.value}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) return;

            showLoader();
            const updatedServers = userServers.filter(server => server.id !== serverId);
            const userDocRef = db.collection('users').doc(currentUser.uid);
            try {
                await Promise.all([
                    userDocRef.update({ servers: updatedServers }),
                    rtdb.ref('servers/' + serverId).remove()
                ]);
                closeModal(serverModal);
                await loadUserServersAndPreferences();
            } catch (error) {
                console.error("Error deleting server:", error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³Ø±ÙˆØ±.');
            } finally {
                hideLoader();
            }
        }
        
        // --- Event Listeners ---
        themeToggleBtn.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
            applyTheme(newTheme);
            saveThemePreference(newTheme);
        });
        
        logoutBtn.addEventListener('click', () => {
            if (confirm("Ø¢ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) {
                auth.signOut();
            }
        });
        
        addServerBtn.addEventListener('click', openModalForCreate);
        profileBtn.addEventListener('click', openProfileModal);

        // Server Modal Listeners
        cancelBtn.addEventListener('click', () => closeModal(serverModal));
        submitBtn.addEventListener('click', handleFormSubmit);
        deleteBtn.addEventListener('click', deleteServer);
        serverTypeSelect.addEventListener('change', () => toggleEditorView(serverTypeSelect.value));
        htmlContentInput.addEventListener('input', () => htmlPreview.srcdoc = htmlContentInput.value);
        copyLinkBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(serverLinkInput.value).then(() => {
                copyTooltip.classList.add('visible');
                setTimeout(() => copyTooltip.classList.remove('visible'), 2000);
            });
        });

        // Profile Modal Listeners
        profileCancelBtn.addEventListener('click', () => closeModal(profileModal));
        profileSubmitBtn.addEventListener('click', handleProfileUpdate);
        resetPasswordBtn.addEventListener('click', handlePasswordReset);

    </script>
</body>
</html>
