<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡ - Norix</title>

    <!-- START: CodeMirror Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    <!-- END: CodeMirror Dependencies -->

    <style>
        /* Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ… Ø±ÙˆØ´Ù† Ùˆ ØªÛŒØ±Ù‡ */
        :root {
            --primary-color: #3498db;
            --primary-hover-color: #2980b9;
            --primary-color-rgb: 52, 152, 219;
            --danger-color: #e74c3c;
            --danger-hover-color: #c0392b;
            --success-color: #2ecc71;

            /* Light Theme */
            --bg-color: #f4f7f6;
            --card-bg-color: #fff;
            --header-bg-color: #fff;
            --text-color: #333;
            --light-text-color: #777;
            --border-color: #ddd;
            --shadow-light: rgba(0,0,0,0.08);
            --shadow-medium: rgba(0,0,0,0.1);
            --input-bg-color: #fdfdfd;

            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        /* Dark Theme */
        body.dark-theme {
            --bg-color: #1a1a1a;
            --card-bg-color: #2c2c2c;
            --header-bg-color: #252525;
            --text-color: #e0e0e0;
            --light-text-color: #999;
            --border-color: #444;
            --shadow-light: rgba(0,0,0,0.2);
            --shadow-medium: rgba(0,0,0,0.3);
            --input-bg-color: #333;
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ CodeMirror Ø¨Ø±Ø§ÛŒ ØªÙ… ØªÛŒØ±Ù‡ */
        body.dark-theme .CodeMirror {
            border-color: var(--border-color);
            background-color: var(--input-bg-color);
        }
        body.dark-theme .CodeMirror-gutters {
            background-color: #2c2c2c;
            border-right-color: var(--border-color);
        }
        body.dark-theme .cm-s-dracula {
            background-color: #282a36;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ Ø¨Ø¯Ù†Ù‡ Ùˆ ÙÙˆÙ†Øª */
        body, html {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Ù‡Ø¯Ø± ØµÙØ­Ù‡ */
        .header {
            background-color: var(--header-bg-color);
            padding: 15px 25px;
            box-shadow: 0 2px 5px var(--shadow-medium);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background-color 0.3s ease;
        }
        .header-title { font-size: 24px; font-weight: bold; margin: 0; }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        #theme-toggle-btn { background: none; border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; justify-content: center; align-items: center; color: var(--text-color); transition: background-color 0.3s, border-color 0.3s; }
        #theme-toggle-btn:hover { background-color: var(--bg-color); }
        #logout-btn { border: 1px solid var(--danger-color); color: var(--danger-color); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; background: none; }
        #logout-btn:hover { background-color: var(--danger-color); color: #fff; }

        /* Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ù…Ø­ØªÙˆØ§ */
        .main-container { padding: 25px; }
        
        /* START: Dashboard Controls (Search/Filter) */
        .dashboard-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .search-box {
            flex-grow: 1;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 40px; /* Space for icon */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg-color);
            color: var(--text-color);
            font-size: 16px;
        }
        .search-box::before {
            content: 'ğŸ”';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text-color);
        }
        .filter-group select {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg-color);
            color: var(--text-color);
            font-size: 16px;
        }
        /* END: Dashboard Controls */

        #server-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }

        /* Ú©Ø§Ø±Øª Ù†Ù…Ø§ÛŒØ´ Ù‡Ø± Ø³Ø±ÙˆØ± (Ø·Ø±Ø§Ø­ÛŒ Ø¬Ø¯ÛŒØ¯) */
        .server-card { background-color: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-light); transition: transform 0.2s ease, box-shadow 0.2s ease; overflow: hidden; border-left: 5px solid var(--primary-color); position: relative; }
        .server-card:hover { transform: translateY(-5px); box-shadow: 0 6px 20px var(--shadow-medium); }
        .server-card-content { padding: 20px; display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .server-icon { font-size: 32px; line-height: 1; }
        .server-details { flex-grow: 1; }
        .server-name { font-size: 18px; font-weight: 600; margin: 0; }
        .server-meta { font-size: 13px; color: var(--light-text-color); }
        .server-meta span { margin-left: 10px; }
        .server-card-actions { position: absolute; top: 10px; left: 10px; display: flex; gap: 5px; }
        .card-action-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--light-text-color); transition: color 0.2s; padding: 5px; }
        .card-action-btn:hover { color: var(--primary-color); }

        #no-servers-message { text-align: center; margin-top: 50px; color: var(--light-text-color); font-size: 16px; }

        #add-server-btn { position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px; background-color: var(--primary-color); color: #fff; border: none; border-radius: 50%; font-size: 36px; line-height: 60px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; user-select: none; z-index: 999;}
        #add-server-btn:hover { background-color: var(--primary-hover-color); transform: scale(1.1); }

        /* --- START: REFACTORED MODAL STYLES --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 1000; padding: 16px; box-sizing: border-box; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }

        .modal-content { background-color: var(--card-bg-color); border-radius: 16px; width: 100%; max-width: 900px; max-height: 90vh; box-sizing: border-box; box-shadow: 0 8px 30px var(--shadow-medium); display: flex; flex-direction: column; transform: scale(0.95) translateY(10px); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .modal-overlay.visible .modal-content { transform: scale(1) translateY(0); }
        
        #server-form { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        
        .modal-title { font-size: 24px; font-weight: 600; margin: 0; padding: 25px 30px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }

        .modal-body { overflow-y: auto; padding: 30px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; flex-grow: 1; }

        .input-group { text-align: right; display: flex; flex-direction: column; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 15px; color: var(--text-color); }
        .input-group input, .input-group select { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-size: 16px; background-color: var(--input-bg-color); color: var(--text-color); transition: all 0.2s ease; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.25); }

        .full-width-container, #modal-message { grid-column: 1 / -1; }
        
        .personalization-group { display: flex; flex-direction: row; gap: 15px; align-items: flex-end; }
        .personalization-group > div { flex-grow: 1; }
        .personalization-group > div:last-child { flex-grow: 0; }
        .personalization-group input[type="color"] { min-width: 50px; height: 50px; padding: 5px; border-radius: 8px; cursor: pointer; }
        
        .server-link-container { margin-top: 15px; background-color: var(--bg-color); padding: 12px 15px; border-radius: 8px; }
        .server-link-container label { font-size: 14px; margin-bottom: 5px; }
        .server-link-container input { width: 100%; border: none; background: none; font-size: 14px; color: var(--primary-color); direction: ltr; cursor: pointer; padding: 0; }
        
        /* START: HTML Editor Tabs */
        .html-editor-tabs { display: flex; border-bottom: 1px solid var(--border-color); }
        .tab-btn { padding: 10px 15px; cursor: pointer; background: none; border: none; font-size: 15px; color: var(--light-text-color); font-weight: 500; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* END: HTML Editor Tabs */
        
        /* START: JSON Multi-Path Editor */
        .json-path-item { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .json-path-item input { direction: ltr; text-align: left; }
        .json-path-item .CodeMirror { flex-grow: 1; }
        .remove-path-btn { background: none; border: 1px solid var(--danger-color); color: var(--danger-color); border-radius: 8px; cursor: pointer; width: 40px; height: 40px; font-size: 20px; }
        #add-json-path-btn { background-color: var(--bg-color); border: 1px dashed var(--border-color); color: var(--text-color); padding: 10px; width: 100%; border-radius: 8px; cursor: pointer; }
        /* END: JSON Multi-Path Editor */

        /* CodeMirror styles */
        .CodeMirror { border: 1px solid var(--border-color); border-radius: 8px; height: auto; min-height: 200px; font-family: 'Courier New', monospace; font-size: 14px; }

        #html-preview { width: 100%; height: 250px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fff; }

        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: auto; border-top: 1px solid var(--border-color); padding: 20px 30px; background-color: var(--header-bg-color); border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; flex-shrink: 0; }
        .modal-btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        #submit-btn { background-color: var(--primary-color); color: #fff; order: 3; }
        #submit-btn:hover { background-color: var(--primary-hover-color); }
        #cancel-btn { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); order: 2; }
        #cancel-btn:hover { background-color: var(--border-color); }
        #delete-btn { background-color: transparent; color: var(--danger-color); font-weight: 500; order: 1; margin-right: auto; }
        #delete-btn:hover { background-color: rgba(231, 76, 60, 0.1); }
        
        #modal-message { color: var(--danger-color); min-height: 20px; font-weight: 500; text-align: center; }

        /* Ø³ÙˆÛŒÛŒÚ† */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        @media (max-width: 768px) {
            .modal-content { max-width: 100%; max-height: 95vh; }
            .modal-body { grid-template-columns: 1fr; padding: 20px; gap: 20px; }
            .modal-title { padding: 20px; font-size: 20px; }
            .modal-actions { padding: 15px; flex-direction: column-reverse; }
            .modal-btn { width: 100%; }
            #delete-btn { margin-right: 0; margin-top: 8px; }
            #add-server-btn { bottom: 20px; right: 20px; left: auto; }
        }
        /* --- END: REFACTORED MODAL STYLES --- */
    </style>
</head>
<body>

    <header class="header">
        <h1 class="header-title">Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…Ù†</h1>
        <div class="header-actions">
            <button id="theme-toggle-btn" title="ØªØºÛŒÛŒØ± ØªÙ…">â˜€ï¸</button>
            <button id="logout-btn">Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <main class="main-container">
        <!-- START: Dashboard Controls -->
        <div class="dashboard-controls">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù… Ø³Ø±ÙˆØ±...">
            </div>
            <div class="filter-group">
                <select id="filter-type">
                    <option value="all">Ù‡Ù…Ù‡ Ù†ÙˆØ¹â€ŒÙ‡Ø§</option>
                    <option value="json">JSON</option>
                    <option value="html">HTML</option>
                </select>
            </div>
            <div class="filter-group">
                <select id="filter-visibility">
                    <option value="all">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                    <option value="public">Ø¹Ù…ÙˆÙ…ÛŒ</option>
                    <option value="private">Ø®ØµÙˆØµÛŒ</option>
                </select>
            </div>
        </div>
        <!-- END: Dashboard Controls -->

        <div id="server-list"></div>
        <p id="no-servers-message" style="display: none;">Ù‡Ù†ÙˆØ² Ø³Ø±ÙˆØ±ÛŒ Ù†Ø³Ø§Ø®ØªÙ‡â€ŒØ§ÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒ Ø¹Ù„Ø§Ù…Øª + Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</p>
    </main>

    <button id="add-server-btn" title="Ø³Ø§Ø®Øª Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯">+</button>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ø³Ø±ÙˆØ± -->
    <div id="server-modal" class="modal-overlay">
        <div class="modal-content">
            <form id="server-form" onsubmit="return false;">
                <h2 id="modal-title" class="modal-title">Ø³Ø§Ø®Øª Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯</h2>
                <div class="modal-body">
                    
                    <input type="hidden" id="server-id-input">
                    
                    <!-- START: Template Selector (Create Mode Only) -->
                    <div class="input-group full-width-container" id="template-container">
                        <label for="template-select">Ø´Ø±ÙˆØ¹ Ø¨Ø§ ÛŒÚ© Ù‚Ø§Ù„Ø¨ Ø¢Ù…Ø§Ø¯Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                        <select id="template-select">
                            <option value="none">Ø´Ø±ÙˆØ¹ Ø§Ø² ØµÙØ±</option>
                            <optgroup label="JSON Templates">
                                <option value="json-users">Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</option>
                                <option value="json-products">Ú©Ø§ØªØ§Ù„ÙˆÚ¯ Ù…Ø­ØµÙˆÙ„Ø§Øª</option>
                            </optgroup>
                            <optgroup label="HTML Templates">
                                <option value="html-portfolio">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø³Ø§Ø¯Ù‡</option>
                                <option value="html-landing">ØµÙØ­Ù‡ ÙØ±ÙˆØ¯</option>
                            </optgroup>
                        </select>
                    </div>
                    <!-- END: Template Selector -->

                    <div class="input-group">
                        <label for="server-name-input">Ù†Ø§Ù… Ø³Ø±ÙˆØ±</label>
                        <input type="text" id="server-name-input" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="server-type-select">Ù†ÙˆØ¹ Ø³Ø±ÙˆØ±</o-label>
                        <select id="server-type-select">
                            <option value="json">JSON</option>
                            <option value="html">HTML</option>
                        </select>
                    </div>

                    <div class="input-group" id="password-container">
                        <label for="server-password-input">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø³Ø±ÙˆØ± (Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª)</label>
                        <input type="password" id="server-password-input">
                    </div>

                    <div class="input-group personalization-group">
                         <div style="flex-grow: 1;">
                            <label for="server-icon-input">Ø¢ÛŒÚ©ÙˆÙ† (Ø§ÛŒÙ…ÙˆØ¬ÛŒ)</label>
                            <input type="text" id="server-icon-input" maxlength="2" placeholder="ğŸš€">
                         </div>
                         <div>
                            <label for="server-color-input">Ø±Ù†Ú¯</label>
                            <input type="color" id="server-color-input" value="#3498db">
                         </div>
                    </div>

                    <div class="input-group">
                         <label>Ù†Ù…Ø§ÛŒØ´ Ø¹Ù…ÙˆÙ…ÛŒ (Public)</label>
                         <label class="switch">
                           <input type="checkbox" id="server-visibility-toggle" checked>
                           <span class="slider"></span>
                         </label>
                    </div>
                    
                    <!-- START: Custom Slug Input -->
                    <div class="input-group" id="slug-container" style="display: none;">
                        <label for="server-slug-input">Ø¢Ø¯Ø±Ø³ Ø³ÙØ§Ø±Ø´ÛŒ (ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ -)</label>
                        <input type="text" id="server-slug-input" placeholder="my-awesome-api" pattern="[a-zA-Z0-9-]+" style="direction: ltr; text-align: left;">
                    </div>
                    <!-- END: Custom Slug Input -->

                    <!-- Ø¨Ø®Ø´ ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø±Ù‡Ø§ -->
                    <!-- START: JSON Multi-Path Editor -->
                    <div class="full-width-container" id="json-editor-container">
                        <label>Ù…Ø­ØªÙˆØ§ÛŒ JSON (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø³ÛŒØ±)</label>
                        <div id="json-paths-wrapper"></div>
                        <button type="button" id="add-json-path-btn">+ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø³ÛŒØ± Ø¬Ø¯ÛŒØ¯</button>
                    </div>
                    <!-- END: JSON Multi-Path Editor -->
                    
                    <!-- START: HTML Tabbed Editor -->
                    <div class="full-width-container" id="html-editor-container" style="display: none;">
                        <div class="html-editor-tabs">
                            <button type="button" class="tab-btn active" data-tab="html">HTML</button>
                            <button type="button" class="tab-btn" data-tab="css">CSS</button>
                            <button type="button" class="tab-btn" data-tab="js">JavaScript</button>
                        </div>
                        <div id="tab-html" class="tab-content active"><textarea id="html-content-input"></textarea></div>
                        <div id="tab-css" class="tab-content"><textarea id="css-content-input"></textarea></div>
                        <div id="tab-js" class="tab-content"><textarea id="js-content-input"></textarea></div>
                    </div>
                    <!-- END: HTML Tabbed Editor -->
                    
                    <div class="full-width-container" id="html-preview-wrapper" style="display: none;">
                        <label>Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡</label>
                        <iframe id="html-preview" srcdoc=""></iframe>
                    </div>

                    <div class="server-link-container full-width-container" style="display: none;" id="server-link-wrapper">
                        <label>Ù„ÛŒÙ†Ú© Ø¹Ù…ÙˆÙ…ÛŒ Ø³Ø±ÙˆØ± (Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</label>
                        <input type="text" id="server-link-input" readonly>
                    </div>
                    
                    <p id="modal-message" class="full-width-container"></p>
                </div>
                <div class="modal-actions">
                    <button type="button" id="delete-btn" class="modal-btn" style="display: none;">Ø­Ø°Ù</button>
                    <button type="button" id="cancel-btn" class="modal-btn">Ù„ØºÙˆ</button>
                    <button type="button" id="submit-btn" class="modal-btn">Ø³Ø§Ø®ØªÙ†</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- START: Firebase Configuration (KEEP YOUR VALUES HERE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAT8CDJoCOm8XVo62y-3CgS1Fqabdq2tjQ",
            authDomain: "serverjson-a2107.firebaseapp.com",
            projectId: "serverjson-a2107",
            storageBucket: "serverjson-a2107.firebasestorage.app",
            messagingSenderId: "1058313915119",
            appId: "1:1058313915119:web:4a967e4c8c401f1762a91a",
            measurementId: "G-T3Y95SVYPM",
            databaseURL: "https://serverjson-a2107-default-rtdb.firebaseio.com"
        };
        // --- END: Firebase Configuration ---

        // --- Firebase Initialization ---
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // --- Global Variables & DOM Elements ---
        let currentUser;
        let userServers = []; 
        let jsonPathEditors = {};
        let htmlCodeEditor, cssCodeEditor, jsCodeEditor;
        
        // ... (DOM elements selectors)
        const serverList = document.getElementById('server-list');
        const noServersMessage = document.getElementById('no-servers-message');
        const searchInput = document.getElementById('search-input');
        const filterType = document.getElementById('filter-type');
        const filterVisibility = document.getElementById('filter-visibility');
        const addServerBtn = document.getElementById('add-server-btn');
        const modal = document.getElementById('server-modal');
        const modalTitle = document.getElementById('modal-title');
        const serverForm = document.getElementById('server-form');
        const serverIdInput = document.getElementById('server-id-input');
        const serverNameInput = document.getElementById('server-name-input');
        const serverPasswordInput = document.getElementById('server-password-input');
        const passwordContainer = document.getElementById('password-container');
        const serverTypeSelect = document.getElementById('server-type-select');
        const templateContainer = document.getElementById('template-container');
        const templateSelect = document.getElementById('template-select');
        const serverIconInput = document.getElementById('server-icon-input');
        const serverColorInput = document.getElementById('server-color-input');
        const serverVisibilityToggle = document.getElementById('server-visibility-toggle');
        const slugContainer = document.getElementById('slug-container');
        const serverSlugInput = document.getElementById('server-slug-input');
        const jsonEditorContainer = document.getElementById('json-editor-container');
        const jsonPathsWrapper = document.getElementById('json-paths-wrapper');
        const addJsonPathBtn = document.getElementById('add-json-path-btn');
        const htmlEditorContainer = document.getElementById('html-editor-container');
        const htmlPreviewWrapper = document.getElementById('html-preview-wrapper');
        const htmlPreview = document.getElementById('html-preview');
        const serverLinkWrapper = document.getElementById('server-link-wrapper');
        const serverLinkInput = document.getElementById('server-link-input');
        const modalMessage = document.getElementById('modal-message');
        const logoutBtn = document.getElementById('logout-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const submitBtn = document.getElementById('submit-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        
        // --- Templates ---
        const serverTemplates = {
            'json-users': { type: 'json', content: { "/users": [{id: 1, name: "Ú©Ø§Ø±Ø¨Ø± Ø§ÙˆÙ„"}, {id: 2, name: "Ú©Ø§Ø±Ø¨Ø± Ø¯ÙˆÙ…"}] } },
            'json-products': { type: 'json', content: { "/products": [{id: 101, name: "Ù…Ø­ØµÙˆÙ„ Û±", price: 50}, {id: 102, name: "Ù…Ø­ØµÙˆÙ„ Û²", price: 80}] } },
            'html-portfolio': { type: 'html', content: { html: `<h1>Ù†Ø§Ù… Ø´Ù…Ø§</h1>\n<p>ØªØ®ØµØµ Ø´Ù…Ø§</p>`, css: `body { font-family: sans-serif; text-align: center; }`, js: `console.log("Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯");` } },
            'html-landing': { type: 'html', content: { html: `<main><h1>Ù…Ø­ØµÙˆÙ„ Ø´Ú¯ÙØªâ€ŒØ§Ù†Ú¯ÛŒØ² Ù…Ø§</h1></main>`, css: `main { padding: 50px; }`, js: `` } }
        };

        // --- Authentication & Initialization ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                initializeCodeEditors();
                await loadUserServersAndPreferences();
            } else {
                window.location.href = './Login.html';
            }
        });
        
        async function loadUserServersAndPreferences() {
            try {
                const userDocRef = db.collection('users').doc(currentUser.uid);
                const doc = await userDocRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    applyTheme(data.preferences?.theme || 'light');
                    userServers = data.servers || [];
                    renderServerList();
                } else {
                    applyTheme('light');
                    userServers = [];
                    renderServerList();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª.");
            }
        }

        // --- Dashboard UI (Render, Search, Filter) ---
        function renderServerList() {
            const searchTerm = searchInput.value.toLowerCase();
            const typeFilter = filterType.value;
            const visibilityFilter = filterVisibility.value;

            const filteredServers = userServers.filter(server => {
                const nameMatch = server.name.toLowerCase().includes(searchTerm);
                const typeMatch = typeFilter === 'all' || server.type === typeFilter;
                const visibilityMatch = visibilityFilter === 'all' || server.visibility === visibilityFilter;
                return nameMatch && typeMatch && visibilityMatch;
            });
            
            serverList.innerHTML = '';
            noServersMessage.style.display = filteredServers.length === 0 ? 'block' : 'none';
            filteredServers.forEach(displayServerCard);
        }

        function displayServerCard(server) {
            const card = document.createElement('div');
            card.className = 'server-card';
            card.dataset.serverId = server.id;
            card.style.borderLeftColor = server.color || 'var(--primary-color)';
            
            const visibilityIcon = server.visibility === 'public' ? 'ğŸŒ' : 'ğŸ”’';
            const serverType = server.type.toUpperCase();

            card.innerHTML = `
                <div class="server-card-actions">
                    <button class="card-action-btn duplicate-btn" title="ØªÚ©Ø«ÛŒØ± Ø³Ø±ÙˆØ±">ğŸ“„</button>
                </div>
                <div class="server-card-content">
                    <span class="server-icon">${server.icon || 'ğŸš€'}</span>
                    <div class="server-details">
                        <p class="server-name">${server.name}</p>
                        <div class="server-meta">
                           <span>Ù†ÙˆØ¹: ${serverType}</span>
                           <span>${visibilityIcon} ${server.visibility === 'public' ? 'Ø¹Ù…ÙˆÙ…ÛŒ' : 'Ø®ØµÙˆØµÛŒ'}</span>
                        </div>
                    </div>
                </div>
            `;
            card.querySelector('.server-card-content').addEventListener('click', () => openModalForEdit(server.id));
            card.querySelector('.duplicate-btn').addEventListener('click', () => duplicateServer(server.id));
            serverList.appendChild(card);
        }

        // --- Code Editor Management ---
        function createCodeMirrorInstance(textarea, mode) {
            return CodeMirror.fromTextArea(textarea, {
                lineNumbers: true,
                mode: mode,
                theme: document.body.classList.contains('dark-theme') ? 'dracula' : 'default',
                lineWrapping: true,
                indentUnit: 2
            });
        }
        
        function initializeCodeEditors() {
            htmlCodeEditor = createCodeMirrorInstance(document.getElementById('html-content-input'), 'htmlmixed');
            cssCodeEditor = createCodeMirrorInstance(document.getElementById('css-content-input'), 'css');
            jsCodeEditor = createCodeMirrorInstance(document.getElementById('js-content-input'), 'javascript');
            
            [htmlCodeEditor, cssCodeEditor, jsCodeEditor].forEach(editor => {
                editor.on('change', updateHtmlPreview);
            });
        }
        
        function refreshAllEditors() {
            [htmlCodeEditor, cssCodeEditor, jsCodeEditor, ...Object.values(jsonPathEditors)].forEach(editor => {
                if (editor) editor.refresh();
            });
        }

        function updateHtmlPreview() {
            const html = htmlCodeEditor.getValue();
            const css = cssCodeEditor.getValue();
            const js = jsCodeEditor.getValue();
            const srcDoc = `
                <html>
                    <head><style>${css}</style></head>
                    <body>${html}<script>${js}<\/script></body>
                </html>
            `;
            htmlPreview.srcdoc = srcDoc;
        }
        
        // --- JSON Multi-Path UI ---
        function addJsonPath(path = '', content = {}) {
            const pathId = `path_${Date.now()}`;
            const wrapper = document.createElement('div');
            wrapper.className = 'json-path-item';
            wrapper.innerHTML = `
                <input type="text" placeholder="/path" value="${path}" class="json-path-input" required>
                <button type="button" class="remove-path-btn">Ã—</button>
            `;
            const textarea = document.createElement('textarea');
            wrapper.insertBefore(textarea, wrapper.querySelector('.remove-path-btn'));
            jsonPathsWrapper.appendChild(wrapper);

            const editor = createCodeMirrorInstance(textarea, { name: 'javascript', json: true });
            editor.setValue(JSON.stringify(content, null, 2));
            jsonPathEditors[pathId] = editor;
            
            wrapper.querySelector('.remove-path-btn').addEventListener('click', () => {
                wrapper.remove();
                delete jsonPathEditors[pathId];
            });
        }
        
        // --- Modal Management ---
        function openModalForCreate() {
            serverForm.reset();
            serverIdInput.value = '';
            modalTitle.textContent = 'Ø³Ø§Ø®Øª Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯';
            submitBtn.textContent = 'Ø³Ø§Ø®ØªÙ†';
            serverPasswordInput.required = true;
            passwordContainer.style.display = 'block';
            serverTypeSelect.disabled = false;
            templateContainer.style.display = 'block';
            deleteBtn.style.display = 'none';
            serverLinkWrapper.style.display = 'none';
            slugContainer.style.display = serverVisibilityToggle.checked ? 'block' : 'none';
            serverColorInput.value = '#3498db';
            serverIconInput.value = '';
            serverVisibilityToggle.checked = true;
            serverSlugInput.value = '';
            
            jsonPathsWrapper.innerHTML = '';
            jsonPathEditors = {};
            addJsonPath('/', { message: "Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯." });

            toggleEditorView('json');
            modal.classList.add('visible');
            setTimeout(refreshAllEditors, 10); // Refresh after modal animation
        }

        function openModalForEdit(serverId) {
            const server = userServers.find(s => s.id === serverId);
            if (!server) return;

            serverForm.reset();
            serverIdInput.value = server.id;
            serverNameInput.value = server.name;
            serverTypeSelect.value = server.type || 'json';
            serverTypeSelect.disabled = true;
            templateContainer.style.display = 'none';
            
            serverPasswordInput.required = false;
            passwordContainer.style.display = 'none';

            serverIconInput.value = server.icon || 'ğŸš€';
            serverColorInput.value = server.color || '#3498db';
            serverVisibilityToggle.checked = server.visibility === 'public';
            serverSlugInput.value = server.slug || '';
            slugContainer.style.display = server.visibility === 'public' ? 'block' : 'none';
            
            modalTitle.textContent = `ÙˆÛŒØ±Ø§ÛŒØ´ Ø³Ø±ÙˆØ±: ${server.name}`;
            submitBtn.textContent = 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
            
            jsonPathsWrapper.innerHTML = '';
            jsonPathEditors = {};

            if (server.type === 'html') {
                const content = server.content || {};
                htmlCodeEditor.setValue(content.html || '');
                cssCodeEditor.setValue(content.css || '');
                jsCodeEditor.setValue(content.js || '');
            } else { // JSON type
                // Handle both old format (object) and new format (object of objects)
                const content = server.content || {};
                if (Object.keys(content).length === 0 || typeof Object.values(content)[0] !== 'object') {
                    // Old format, convert it
                    addJsonPath('/', content);
                } else {
                    for (const path in content) {
                        addJsonPath(path, content[path]);
                    }
                }
            }
            toggleEditorView(server.type || 'json');
            
            updateServerLink(server);
            
            deleteBtn.style.display = 'block';
            modal.classList.add('visible');
            setTimeout(refreshAllEditors, 10);
        }

        function closeModal() {
            modal.classList.remove('visible');
            modalMessage.textContent = '';
        }
        
        function updateServerLink(server) {
            if (server.visibility === 'public') {
                const slug = server.slug || server.id;
                const link = `https://your-viewer-domain/view/${slug}`; // TODO: Replace with actual viewer URL
                serverLinkInput.value = link;
                serverLinkInput.onclick = () => window.open(link, '_blank');
                serverLinkWrapper.style.display = 'block';
            } else {
                serverLinkWrapper.style.display = 'none';
            }
        }
        
        // --- Form & Data Handling ---
        function toggleEditorView(type) {
            if (type === 'html') {
                jsonEditorContainer.style.display = 'none';
                htmlEditorContainer.style.display = 'block';
                htmlPreviewWrapper.style.display = 'block';
            } else { // json
                jsonEditorContainer.style.display = 'block';
                htmlEditorContainer.style.display = 'none';
                htmlPreviewWrapper.style.display = 'none';
            }
        }

        function applyTemplate() {
            const templateKey = templateSelect.value;
            if (templateKey === 'none') return;

            const template = serverTemplates[templateKey];
            serverTypeSelect.value = template.type;
            toggleEditorView(template.type);

            if (template.type === 'html') {
                htmlCodeEditor.setValue(template.content.html || '');
                cssCodeEditor.setValue(template.content.css || '');
                jsCodeEditor.setValue(template.content.js || '');
            } else {
                jsonPathsWrapper.innerHTML = '';
                jsonPathEditors = {};
                for (const path in template.content) {
                    addJsonPath(path, template.content[path]);
                }
            }
        }

        function sanitizeForPublicDb(server) {
            return {
                type: server.type,
                name: server.name,
                icon: server.icon,
                content: server.content,
                // Do NOT include password, visibility, color etc.
            };
        }
        
        async function isSlugUnique(slug, serverId) {
            if (!slug) return true;
            const slugDoc = await db.collection('slugs').doc(slug).get();
            if (!slugDoc.exists) return true; // Slug is not taken
            // Slug exists, check if it belongs to the current server being edited
            return slugDoc.data().serverId === serverId;
        }

        async function handleFormSubmit() {
            submitBtn.disabled = true;
            modalMessage.textContent = '';
            const serverId = serverIdInput.value;
            
            try {
                // --- Basic Validation ---
                const serverName = serverNameInput.value.trim();
                if (!serverName) throw new Error('Ù†Ø§Ù… Ø³Ø±ÙˆØ± Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.');
                const isPublic = serverVisibilityToggle.checked;
                const slug = serverSlugInput.value.trim();
                if (isPublic && slug && !/^[a-zA-Z0-9-]+$/.test(slug)) {
                    throw new Error('Ø¢Ø¯Ø±Ø³ Ø³ÙØ§Ø±Ø´ÛŒ ÙÙ‚Ø· Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ Ø®Ø· ØªÛŒØ±Ù‡ (-) Ø¨Ø§Ø´Ø¯.');
                }
                
                if (isPublic && slug && !(await isSlugUnique(slug, serverId))) {
                     throw new Error('Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ø³ÙØ§Ø±Ø´ÛŒ Ù‚Ø¨Ù„Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.');
                }
                
                // --- Collect Content ---
                let content;
                const serverType = serverTypeSelect.value;
                if (serverType === 'html') {
                    content = {
                        html: htmlCodeEditor.getValue(),
                        css: cssCodeEditor.getValue(),
                        js: jsCodeEditor.getValue()
                    };
                } else { // JSON
                    content = {};
                    const pathItems = jsonPathsWrapper.querySelectorAll('.json-path-item');
                    let isValid = true;
                    pathItems.forEach((item, index) => {
                        const path = item.querySelector('.json-path-input').value.trim();
                        if (!path) {
                            isValid = false;
                            throw new Error(`Ù…Ø³ÛŒØ± Ø´Ù…Ø§Ø±Ù‡ ${index + 1} Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.`);
                        }
                        const editorId = Object.keys(jsonPathEditors)[index];
                        const jsonText = jsonPathEditors[editorId].getValue().trim();
                        try {
                           content[path] = jsonText ? JSON.parse(jsonText) : {};
                        } catch (e) {
                           isValid = false;
                           throw new Error(`Ù…Ø­ØªÙˆØ§ÛŒ JSON Ø¯Ø± Ù…Ø³ÛŒØ± "${path}" Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.`);
                        }
                    });
                     if (!isValid) return; // Stop execution if validation failed in loop
                }

                // --- Create or Update ---
                if (serverId) {
                    await updateServer(serverId, serverName, slug, isPublic, content);
                } else {
                    const serverPassword = serverPasswordInput.value.trim();
                    if (!serverPassword) throw new Error('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø³Ø±ÙˆØ± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.');
                    await createNewServer(serverName, serverPassword, serverType, slug, isPublic, content);
                }
            } catch (error) {
                console.error("Form submission error:", error);
                modalMessage.textContent = error.message || 'ÛŒÚ© Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø±Ø® Ø¯Ø§Ø¯.';
            } finally {
                submitBtn.disabled = false;
            }
        }
        
        async function createNewServer(name, password, type, slug, isPublic, content) {
            const newServer = {
                id: Date.now().toString(),
                name: name,
                password: password, // Note: Storing password directly is not recommended for production systems
                type: type,
                icon: serverIconInput.value.trim() || 'ğŸš€',
                color: serverColorInput.value,
                visibility: isPublic ? 'public' : 'private',
                slug: slug,
                content: content
            };

            const batch = db.batch();
            const userDocRef = db.collection('users').doc(currentUser.uid);
            batch.set(userDocRef, { servers: firebase.firestore.FieldValue.arrayUnion(newServer) }, { merge: true });

            if (isPublic && slug) {
                const slugDocRef = db.collection('slugs').doc(slug);
                batch.set(slugDocRef, { serverId: newServer.id, owner: currentUser.uid });
            }

            await batch.commit();

            if (isPublic) {
                const publicData = sanitizeForPublicDb(newServer);
                await rtdb.ref(`servers/${newServer.id}`).set(publicData);
                if (slug) await rtdb.ref(`slugs/${slug}`).set(newServer.id);
            }
            
            closeModal();
            await loadUserServersAndPreferences();
        }

        async function updateServer(serverId, newName, newSlug, isPublic, newContent) {
            const serverIndex = userServers.findIndex(s => s.id === serverId);
            if (serverIndex === -1) throw new Error('Ø³Ø±ÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯.');

            const oldServer = { ...userServers[serverIndex] };
            const updatedServer = { ...oldServer, 
                name: newName,
                icon: serverIconInput.value.trim() || 'ğŸš€',
                color: serverColorInput.value,
                visibility: isPublic ? 'public' : 'private',
                slug: newSlug,
                content: newContent
            };
            
            userServers[serverIndex] = updatedServer;

            const batch = db.batch();
            const userDocRef = db.collection('users').doc(currentUser.uid);
            batch.update(userDocRef, { servers: userServers });

            // Slug management
            if (oldServer.slug && oldServer.slug !== newSlug) {
                batch.delete(db.collection('slugs').doc(oldServer.slug));
            }
            if (newSlug && oldServer.slug !== newSlug) {
                batch.set(db.collection('slugs').doc(newSlug), { serverId: serverId, owner: currentUser.uid });
            }
            
            await batch.commit();
            
            // RTDB management
            if (isPublic) {
                await rtdb.ref(`servers/${serverId}`).set(sanitizeForPublicDb(updatedServer));
                if (oldServer.slug && oldServer.slug !== newSlug) await rtdb.ref(`slugs/${oldServer.slug}`).remove();
                if (newSlug) await rtdb.ref(`slugs/${newSlug}`).set(serverId);
            } else { // Server became private
                await rtdb.ref(`servers/${serverId}`).remove();
                if (oldServer.slug) await rtdb.ref(`slugs/${oldServer.slug}`).remove();
            }
            
            closeModal();
            await loadUserServersAndPreferences();
        }

        async function deleteServer() {
            const serverId = serverIdInput.value;
            if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø³Ø±ÙˆØ± "${serverNameInput.value}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) return;

            const serverToDelete = userServers.find(s => s.id === serverId);
            const updatedServers = userServers.filter(s => s.id !== serverId);
            
            const userDocRef = db.collection('users').doc(currentUser.uid);

            try {
                const batch = db.batch();
                batch.update(userDocRef, { servers: updatedServers });
                if (serverToDelete.slug) {
                    batch.delete(db.collection('slugs').doc(serverToDelete.slug));
                }
                await batch.commit();
                
                await rtdb.ref('servers/' + serverId).remove();
                if (serverToDelete.slug) await rtdb.ref('slugs/' + serverToDelete.slug).remove();

                closeModal();
                await loadUserServersAndPreferences();
            } catch (error) {
                console.error("Error deleting server:", error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³Ø±ÙˆØ±.');
            }
        }
        
        async function duplicateServer(serverId) {
             const originalServer = userServers.find(s => s.id === serverId);
             if (!originalServer) return;
             
             const newServer = { ...originalServer,
                id: Date.now().toString(),
                name: `${originalServer.name} (Ú©Ù¾ÛŒ)`,
                slug: '', // Slug must be unique, so we clear it
                visibility: 'private' // Default to private for safety
             };
             
             try {
                const userDocRef = db.collection('users').doc(currentUser.uid);
                await userDocRef.update({
                    servers: firebase.firestore.FieldValue.arrayUnion(newServer)
                });
                await loadUserServersAndPreferences();
             } catch (error) {
                 console.error("Error duplicating server:", error);
                 alert("Ø®Ø·Ø§ Ø¯Ø± ØªÚ©Ø«ÛŒØ± Ø³Ø±ÙˆØ±.");
             }
        }

        // --- Theme Management ---
        function applyTheme(theme) {
            const isDark = theme === 'dark';
            document.body.classList.toggle('dark-theme', isDark);
            themeToggleBtn.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
            // Update CodeMirror themes
            const editorTheme = isDark ? 'dracula' : 'default';
            [htmlCodeEditor, cssCodeEditor, jsCodeEditor, ...Object.values(jsonPathEditors)].forEach(editor => {
                if (editor) editor.setOption('theme', editorTheme);
            });
        }
        
        async function saveThemePreference(theme) {
            if (!currentUser) return;
            await db.collection('users').doc(currentUser.uid).set({ preferences: { theme: theme } }, { merge: true });
        }

        // --- Event Listeners ---
        addServerBtn.addEventListener('click', openModalForCreate);
        cancelBtn.addEventListener('click', closeModal);
        submitBtn.addEventListener('click', handleFormSubmit);
        deleteBtn.addEventListener('click', deleteServer);
        logoutBtn.addEventListener('click', () => auth.signOut());
        themeToggleBtn.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
            applyTheme(newTheme);
            saveThemePreference(newTheme);
        });
        
        searchInput.addEventListener('input', renderServerList);
        filterType.addEventListener('change', renderServerList);
        filterVisibility.addEventListener('change', renderServerList);
        serverTypeSelect.addEventListener('change', () => toggleEditorView(serverTypeSelect.value));
        serverVisibilityToggle.addEventListener('change', (e) => {
            slugContainer.style.display = e.target.checked ? 'block' : 'none';
        });
        templateSelect.addEventListener('change', applyTemplate);
        
        // HTML Editor Tabs
        document.querySelector('.html-editor-tabs').addEventListener('click', (e) => {
            if (e.target.matches('.tab-btn')) {
                const tab = e.target.dataset.tab;
                document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(`tab-${tab}`).classList.add('active');
                refreshAllEditors();
            }
        });
        
        addJsonPathBtn.addEventListener('click', () => addJsonPath('', {}));

        /*
        =======================================================================
        === Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ù…Ù†ÛŒØªÛŒ (SECURITY RULES) Ø¨Ø±Ø§ÛŒ FIREBASE ===
        =======================================================================
        
        **Ù…Ù‡Ù…:** Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ØŒ Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† Ù‚ÙˆØ§Ù†ÛŒÙ† Ø±Ø§ Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Firebase Ø®ÙˆØ¯ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.
        Ø¨Ø¯ÙˆÙ† Ø§ÛŒÙ† Ù‚ÙˆØ§Ù†ÛŒÙ†ØŒ Ù‡Ø± Ú©Ø³ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø±Ø§ Ø¨Ø®ÙˆØ§Ù†Ø¯ ÛŒØ§ ØªØºÛŒÛŒØ± Ø¯Ù‡Ø¯.

        --- FIRESTORE RULES (ÙØ§ÛŒÙ„ firestore.rules) ---
        
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
        
            // Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙÙ‚Ø· Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø³Ù†Ø¯ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø®ÙˆØ¯Ø´Ø§Ù† Ø±Ø§ Ø¨Ø®ÙˆØ§Ù†Ù†Ø¯ Ùˆ Ø¨Ù†ÙˆÛŒØ³Ù†Ø¯
            match /users/{userId} {
              allow read, update, delete: if request.auth != null && request.auth.uid == userId;
              allow create: if request.auth != null;
            }
        
            // Ø§Ø³Ù„Ø§Ú¯â€ŒÙ‡Ø§ (Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ) Ø¨Ø§ÛŒØ¯ Ù‚Ø§Ø¨Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† ØªÙˆØ³Ø· Ù‡Ù…Ù‡ Ø¨Ø§Ø´Ù†Ø¯ ØªØ§ Ø¨ØªÙˆØ§Ù† Ø§Ø² ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨ÙˆØ¯Ù†Ø´Ø§Ù† Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ú©Ø±Ø¯
            // Ø§Ù…Ø§ ÙÙ‚Ø· ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ù…Ø§Ù„Ú© Ù‚Ø§Ø¨Ù„ Ø³Ø§Ø®Øª Ùˆ Ø­Ø°Ù Ù‡Ø³ØªÙ†Ø¯
            match /slugs/{slug} {
              allow read: if true;
              allow create: if request.auth != null && request.resource.data.owner == request.auth.uid;
              allow delete: if request.auth != null && resource.data.owner == request.auth.uid;
            }
          }
        }

        --- REALTIME DATABASE RULES (ÙØ§ÛŒÙ„ rules.json) ---
        
        {
          "rules": {
            // Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ ØªÙˆØ³Ø· Ù‡Ù…Ù‡ Ù‚Ø§Ø¨Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ø³ØªÙ†Ø¯
            "servers": {
              ".read": true,
              "$serverId": {
                // ÙÙ‚Ø· Ú©Ù„Ø§ÛŒÙ†Øª Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù†ÙˆÛŒØ³Ø¯ (Ø§ÛŒÙ† Ù‚Ø§Ù†ÙˆÙ† Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø´ÙˆØ¯ØŒ Ù…Ø«Ù„Ø§ Ø¨Ø§ Cloud Functions)
                // Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª Ø¨ÛŒØ´ØªØ±ØŒ Ù†ÙˆØ´ØªÙ† Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² Ú©Ù„Ø§ÛŒÙ†Øª Ø±Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ø² Cloud Functions Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
                ".write": "auth != null" 
              }
            },
            // Ø§Ø³Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ù‡Ù… ØªÙˆØ³Ø· Ù‡Ù…Ù‡ Ù‚Ø§Ø¨Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ø³ØªÙ†Ø¯
            "slugs": {
                ".read": true,
                ".write": "auth != null" // Ù…Ø§Ù†Ù†Ø¯ Ø¨Ø§Ù„Ø§ØŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª Ø¨ÛŒØ´ØªØ± Ø§Ø² Cloud Functions Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯
            }
          }
        }
        =======================================================================
        */
    </script>
</body>
</html>
